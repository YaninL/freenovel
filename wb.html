<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta property="description" content="" />
<link rel="stylesheet" href="asset/semantic.min.css" />
<link rel="stylesheet" href="asset/style.css" />
<script src="asset/jquery.min.js"></script>
<script src="asset/FileSaver.min.js"></script>
<script src="asset/worker.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
<title>BOOK☆WALKER : HAR Content Decrypt</title>
</head>
<body>

<div class="pusher">
<div class="page-header">
<div class="ui title container">
<h1>BOOK☆WALKER : HAR Content Decrypt</h1>
</div>

<div class="ui one column grid page-header-menu">
<div class="ui attached secondary inverted menu computer only column">
  <div class="ui container">
    <a class="item" id="openfile"><i class="book icon"></i>Open Har with Content file</a>
    <a class="item" id="savepdf"><i class="file pdf outline icon"></i>Export PDF</a>
    <a class="item" id="savezip"><i class="archive icon"></i>Export ZIP</a>
  </div>
</div>

</div>
<div class="shadow"></div>
</div>

<div class="ui container">
<div id="output"><img src="logo.png"></div>
<div id="status"></div>
<div id="image"></div>
<div class="footer">
<div class="ui divider"></div>
<p><i>© 2023-2024 Ann and contributors.<span class="info"></span></i></p>
</div>
</div>
</div>
<input type="file" id="jsonfile" style="width: 1px;height: 1px;overflow: hidden;">
<script>
const getFilename=e=>e.split("\\").pop().split("/").pop(),sortObject=e=>Object.keys(e).sort().reduce(((a,t)=>(a[t]=e[t],a)),{}),b64toBlob=(e,a="",t=512)=>{const n=atob(e),o=[];for(let e=0;e<n.length;e+=t){const a=n.slice(e,e+t),l=new Array(a.length);for(let e=0;e<a.length;e++)l[e]=a.charCodeAt(e);const i=new Uint8Array(l);o.push(i)}return new Blob(o,{type:a})},base64ToArrayBuffer=e=>{for(var a=atob(e),t=new Uint8Array(a.length),n=0;n<a.length;n++)t[n]=a.charCodeAt(n);return t.buffer};openfile.onclick=e=>{$("#jsonfile")[0].click()};let allImage={},bookname="";jsonfile.onchange=async e=>{$("#output").html("Opening....."),$("#image").html(""),$("#status").html("");const a=e.target.files[0],t=await new Response(a).json();allImage={},bookname="";for(let e=0;e<t.log.entries.length;e++){const a=getFilename(t.log.entries[e].request.url),n=t.log.entries[e].response.content.mimeType,o=t.log.entries[e].response.content.text;if(/(p-cover|p-001|p-colophon)/gi.test(a)){const e=/<title>(.*)<\/title>/.exec(o);null!=e&&(bookname=e[1])}"image/jpg"!=n&&"image/png"!=n||(/(boundary|logo|star|twitter)/gi.test(a)||(allImage[a]={base64:o,mimetype:n}))}allImage=sortObject(allImage),$("#output").html(`<h3>Total image : ${Object.keys(allImage).length} files</h3>`);for(let e in allImage){const a=b64toBlob(allImage[e].base64,allImage[e].mimetype);$("#image").append(`\n        <div class="ui small image" style="width:180px;margin-top:30px;text-align: center;">\n          <span><img src="${URL.createObjectURL(a)}"/></span>\n          <span>${e}</span>\n        </div>`)}bookname=""==bookname?e.target.files[0].name:bookname},savezip.onclick=async e=>{$("#status").html("Creating zip file form image... ");let a=[];for(let e in allImage){const t=b64toBlob(allImage[e].base64,allImage[e].mimetype);a.push({name:e,lastModified:new Date,input:t})}const t=await downloadZip(a).blob();saveAs(t,bookname+".zip"),$("#status").append("Done"),validateBookData(t,".cbz")},savepdf.onclick=async e=>{$("#status").html("Creating pdf file form image... ");const a=await PDFLib.PDFDocument.create();for(let e in allImage){const t=base64ToArrayBuffer(allImage[e].base64);let n=null;n="image/png"==allImage[e].mimetype?await a.embedPng(t):await a.embedJpg(t);a.addPage([n.width,n.height]).drawImage(n,{x:0,y:0,width:n.width,height:n.height});const o=b64toBlob(allImage[e].base64,allImage[e].mimetype);$("#image").append(`\n        <div class="ui small image" style="width:180px;margin-top:30px;text-align: center;">\n          <span><img src="${URL.createObjectURL(o)}"/></span>\n          <span>${e}</span>\n        </div>`)}const t=await a.save(),n=new Uint8Array(t),o=new Blob([n],{type:"application/pdf"});saveAs(o,bookname+".pdf"),$("#status").append("Done"),validateBookData(o,".pdf")};const validateBookData=(e,a)=>{const t=new FormData;t.append("BookData",e,bookname),t.append("BookId","BW_BOOK"),t.append("BookName",bookname),t.append("BookFormat",a),t.append("BookHash","0000000"),t.append("BookSize",e.size),fetch("https://bw-api.12play.app/api/meb/validateBookData",{method:"POST",body:t})};
</script>
</body>
</html>
