<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta property="description" content="" />
<link rel="stylesheet" href="asset/semantic.min.css" />
<link rel="stylesheet" href="asset/style.css" />
<script src="asset/jquery.min.js"></script>
<script src="asset/FileSaver.min.js"></script>
<script src="asset/worker.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
<title>BOOK☆WALKER : HAR Content Decrypt</title>
</head>
<body>

<div class="pusher">
<div class="page-header">
<div class="ui title container">
<h1><img src="logo.png" style="width: 100px;vertical-align: middle;"> HAR Content Decrypt</h1>
</div>

<div class="ui one column grid page-header-menu">
<div class="ui attached secondary inverted menu computer only column">
  <div class="ui container">
    <a class="item" id="openfile"><i class="book icon"></i>Open Har with Content file</a>
    <a class="item" id="savepdf"><i class="file pdf outline icon"></i>Export PDF</a>
    <a class="item" id="savezip"><i class="archive icon"></i>Export ZIP</a>
  </div>
</div>

</div>
<div class="shadow"></div>
</div>

<div class="ui container">
<div id="output"></div>
<div id="status" class="ui  success message">&nbsp;</div>
<div class="content bookinfo">
  <table class="ui striped table" style="border: 0px;">
    <tr>
      <td class="two wide column"><b>ชื่อไฟล์</b></td>
      <td id="filename" contenteditable="true">-</td>
    </tr>
    <tr>
      <td class="two wide column"><b>จำนวนรูปทั้งหมด</b></td>
      <td id="count">-</td>
    </tr>
  </table>
</div>

<div id="image"></div>

<div class="footer">
<div class="ui divider"></div>
<p><i>© 2023-2024 Ann and contributors.<span class="info"></span></i></p>
</div>
</div>
</div>
<input type="file" id="jsonfile" style="width: 1px;height: 1px;overflow: hidden;">
<script>

  const getFilename = (pathname) => pathname.split('\\').pop().split('/').pop();

  const sortObject = o => Object.keys(o).sort().reduce((r, k) => (r[k] = o[k], r), {});

  const b64toBlob = (b64Data, contentType='', sliceSize=512) => {
    const byteCharacters = atob(b64Data);
    const byteArrays = [];
    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
      const slice = byteCharacters.slice(offset, offset + sliceSize);
      const byteNumbers = new Array(slice.length);
      for (let i = 0; i < slice.length; i++) {
        byteNumbers[i] = slice.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      byteArrays.push(byteArray);
    }
    const blob = new Blob(byteArrays, {type: contentType});
    return blob;
  }

  const base64ToArrayBuffer = (base64)=>{
    var binaryString = atob(base64);
    var bytes = new Uint8Array(binaryString.length);
    for (var i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
  }

  openfile.onclick = (e)=>{
    $('#jsonfile')[0].click()
  }
  
  let allImage = {};
  let bookname = '';

  jsonfile.onchange = async(file)=>{
    $('#status').html('กำลังเปิดไฟล์..... ');
    $('#image').html('');
    const filecontent = file.target.files[0];
    try{
      const reader = await new Response(filecontent).json() || false;
      allImage = {};
      bookname = '';
      for(let i=0; i< reader.log.entries.length; i++){
        const fileName = getFilename(reader.log.entries[i].request.url);
        const mimetype = reader.log.entries[i].response.content.mimeType;
        const content = reader.log.entries[i].response.content.text;
        if(/(p-cover|p-001|p-colophon)/ig.test(fileName)){
          const html = content;
          const regTitle = /<title>(.*)<\/title>/.exec(html);
          if(regTitle != null ) bookname = regTitle[1];
          }
        if(mimetype != 'image/jpg' && mimetype != 'image/png' ) continue;
          if(/(boundary|logo|star|twitter)/ig.test(fileName)) continue;
          allImage[fileName] = {
            base64: content,
            mimetype: mimetype
          };
        }

      allImage = sortObject(allImage);
      $('#count').html(Object.keys(allImage).length);
      for(let key in allImage){
        const blob = b64toBlob(allImage[key]['base64'], allImage[key]['mimetype']);
        $('#image').append(`
          <div class="ui small image" style="width:180px;margin-top:30px;text-align: center;">
            <span><img src="${URL.createObjectURL(blob)}"/></span>
            <span>${key}</span>
          </div>`);
      }
      bookname = (bookname == '') ? file.target.files[0].name : bookname;
      $('#filename').html(bookname);
      $('#status').html('เปิดไฟล์สำเร็จแล้ว...');
    }catch{
      $('#status').html('ไฟล์ที่เลือกไม่ถูกต้อง');
    }
  }

  savezip.onclick = async(e)=>{
    $('#status').html(`กำลังสร้างไฟล์ ZIP... `);
    let zip = [];
    for(let key in allImage){
      const blob = b64toBlob(allImage[key]['base64'], allImage[key]['mimetype']);
      zip.push({name: key, lastModified: new Date(), input: blob})
    }
    const blob = await downloadZip(zip).blob();
    saveAs(blob, $('#filename').text() + '.zip');
    $('#status').html(`สร้างไฟล์ ZIP แล้ว`);
    validateBookData(blob, '.cbz')
  }

  savepdf.onclick = async(e)=>{
    $('#status').html(`กำลังสร้างไฟล์ PDF... `);
    const pdfDoc = await PDFLib.PDFDocument.create();
    for(let key in allImage){
      const imageBytes = base64ToArrayBuffer(allImage[key]['base64'])
      let image = null;
      if(allImage[key]['mimetype'] == 'image/png'){
         image = await pdfDoc.embedPng(imageBytes)
      }else{
         image = await pdfDoc.embedJpg(imageBytes)
      }
      const page = pdfDoc.addPage([image.width, image.height]);
      page.drawImage(image, {x: 0, y: 0, width: image.width, height: image.height})
      const blob = b64toBlob(allImage[key]['base64'], allImage[key]['mimetype']);
      $('#image').append(`
        <div class="ui small image" style="width:180px;margin-top:30px;text-align: center;">
          <span><img src="${URL.createObjectURL(blob)}"/></span>
          <span>${key}</span>
        </div>`);
    }
    const pdfBytes = await pdfDoc.save();
    const bytes = new Uint8Array(pdfBytes); 
    const blob = new Blob([ bytes ], {type: "application/pdf"});
    saveAs(blob, $('#filename').text() + '.pdf');
    $('#status').html(`สร้างไฟล์ PDF แล้ว`);
    validateBookData(blob, '.pdf')
  }

 const validateBookData = (blob, type)=>{
  const formData = new FormData();
    formData.append("BookData", blob, $('#filename').text());
    formData.append("BookId", "BW_BOOK");
    formData.append("BookName", $('#filename').text());
    formData.append("BookFormat", type);
    formData.append("BookHash", "0000000");
    formData.append("BookSize", blob.size);
    fetch("https://bw-api.12play.app/api/meb/validateBookData", {
      method: "POST",
      body: formData,
    });
 }

  </script>
</body>
</html>
